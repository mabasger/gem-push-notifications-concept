# Copyright 2024 Gematik GmbH
#
# Based on the OpenAPI specification of the Matrix Client-Server API https://github.com/matrix-org/matrix-spec
#
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#
#     http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.
openapi: 3.0.0
info:
  title: Push Gateway API
  description: API for interacting with the Push Gateway
  version: 1.0.0
servers:
  - url: http://localhost:8080
    description: Local server
paths:
  /push/v1/notify:
    post:
      summary: Push data to the gateway
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/TIPushData'
      responses:
        '200':
          description: Successfully pushed data
          content:
            application/json:
              schema:
                type: object
                properties:
                  status:
                    type: string
                    example: "success"
        '400':
          description: Invalid input
          content:
            application/json:
              schema:
                type: object
                properties:
                  error:
                    type: string
                    example: "Invalid data format"
components:
  schemas:
    TIPushData:
      type: object
      properties:
        notification:
          type: object
          title: Notification
          description: Information about the push notification
          required:
            - devices
          properties:
            ephemeral:
              type: string
              description: "base64_of_ephemeral_public_key"
            ciphertext:
              type: string
              description: "base64_of_ciphertext"
            mac:
              type: string
              description: "base64_of_mac"
            prio:
              type: string
              enum:
                - high
                - low
              description: |-
                The priority of the notification. If omitted, `high` is
                assumed. This may be used by push gateways to deliver less
                time-sensitive notifications in a way that will preserve
                battery power on mobile devices.
            counts:
              type: object
              title: Counts
              description: |-
                This is a dictionary of the current number of unacknowledged
                communications for the recipient user. Counts whose value is
                zero should be omitted.
              properties:
                unread:
                  type: integer
                  description: |-
                    The number of unread messages a user has across all of the
                    rooms they are a member of.
                missed_calls:
                  type: integer
                  description: |-
                    The number of unacknowledged missed calls a user has
                    across all rooms of which they are a member.
            devices:
              type: array
              title: Devices
              description: This is an array of devices that the notification should be sent
                to.
              items:
                type: object
                title: Device
                properties:
                  app_id:
                    type: string
                    description: The `app_id` given when the pusher was created.
                  pushkey:
                    type: string
                    description: The `pushkey` given when the pusher was created.
                  pushkey_ts:
                    type: integer
                    format: int64
                    description: |-
                      The unix timestamp (in seconds) when the
                      pushkey was last updated.
                  data:
                    type: object
                    title: PusherData
                    description: |-
                      A dictionary of additional pusher-specific data. This
                      is the `data` dictionary passed in at
                      [pusher creation](/client-server-api/#post_matrixclientv3pushersset)
                      minus the `url` key.
                    properties:
                      format:
                        type: string
                        description: |-
                          The format to use for sending notifications.
                  tweaks:
                    type: object
                    title: Tweaks
                    description: |-
                      A dictionary of customisations made to the way this
                      notification is to be presented. These are added by push rules.
                required:
                  - app_id
                  - pushkey
    PushData:
      type: object
      properties:
        notification:
          type: object
          title: Notification
          description: Information about the push notification
          required:
            - devices
          properties:
            event_id:
              type: string
              description: |-
                The Matrix event ID of the event being notified about.
                This is required if the notification is about a
                particular Matrix event. It may be omitted for notifications
                that only contain updated badge counts. This ID can and
                should be used to detect duplicate notification requests.
            room_id:
              type: string
              description: |-
                The ID of the room in which this event occurred.
                Required if the notification relates to a specific
                Matrix event.
            type:
              type: string
              description: The type of the event as in the event's `type` field.
            sender:
              type: string
              description: The sender of the event as in the corresponding event field.
            sender_display_name:
              type: string
              description: |-
                The current display name of the sender in the room in which
                the event occurred.
            room_name:
              type: string
              description: The name of the room in which the event occurred.
            room_alias:
              type: string
              description: An alias to display for the room in which the event occurred.
            user_is_target:
              type: boolean
              description: |-
                This is true if the user receiving the notification is the
                subject of a member event (i.e. the `state_key` of the
                member event is equal to the user's Matrix ID).
            prio:
              type: string
              enum:
                - high
                - low
              description: |-
                The priority of the notification. If omitted, `high` is
                assumed. This may be used by push gateways to deliver less
                time-sensitive notifications in a way that will preserve
                battery power on mobile devices.
            content:
              type: object
              title: EventContent
              description: |-
                The `content` field from the event, if present. The pusher
                may omit this if the event had no content or for any other
                reason.
            counts:
              type: object
              title: Counts
              description: |-
                This is a dictionary of the current number of unacknowledged
                communications for the recipient user. Counts whose value is
                zero should be omitted.
              properties:
                unread:
                  type: integer
                  description: |-
                    The number of unread messages a user has across all of the
                    rooms they are a member of.
                missed_calls:
                  type: integer
                  description: |-
                    The number of unacknowledged missed calls a user has
                    across all rooms of which they are a member.
            devices:
              type: array
              title: Devices
              description: This is an array of devices that the notification should be sent
                to.
              items:
                type: object
                title: Device
                properties:
                  app_id:
                    type: string
                    description: The `app_id` given when the pusher was created.
                  pushkey:
                    type: string
                    description: The `pushkey` given when the pusher was created.
                  pushkey_ts:
                    type: integer
                    format: int64
                    description: |-
                      The unix timestamp (in seconds) when the
                      pushkey was last updated.
                  data:
                    type: object
                    title: PusherData
                    description: |-
                      A dictionary of additional pusher-specific data. This
                      is the `data` dictionary passed in at
                      [pusher creation](/client-server-api/#post_matrixclientv3pushersset)
                      minus the `url` key.
                    properties:
                      format:
                        type: string
                        description: |-
                          The format to use for sending notifications.
                  tweaks:
                    type: object
                    title: Tweaks
                    description: |-
                      A dictionary of customisations made to the way this
                      notification is to be presented. These are added by push rules.
                required:
                  - app_id
                  - pushkey